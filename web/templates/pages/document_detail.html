{{define "title"}}{{.Data.Document.Filename}} - Hausdog{{end}}

{{define "content"}}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
        <div>
            <a href="/documents" class="btn btn-ghost btn-sm gap-1 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Documents
            </a>
            <h1 class="text-2xl font-bold flex items-center gap-3">
                <div class="bg-base-200 p-2 rounded-lg">
                    {{if eq .Data.Document.ContentType "application/pdf"}}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    {{else}}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {{end}}
                </div>
                <span class="truncate">{{.Data.Document.Filename}}</span>
            </h1>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-primary btn-outline btn-sm" onclick="reprocessDocument()" id="reprocess-btn">Reprocess</button>
            <button class="btn btn-error btn-outline btn-sm" onclick="deleteDocument()">Delete</button>
        </div>
    </div>

    <!-- Real-time Processing Status (when processing) -->
    {{if or (eq .Data.Document.ProcessingStatus "pending") (eq .Data.Document.ProcessingStatus "processing")}}
    <div
        x-data="processingStatus('{{.Data.Document.ID}}')"
        x-init="init()"
        class="card bg-base-100 shadow-lg border-2 border-primary"
    >
        <div class="card-body">
            <!-- Debug info (remove after fixing) -->
            <div class="text-xs text-base-content/50 mb-2">
                Debug: step=<span x-text="currentStep"></span>, status=<span x-text="status"></span>
            </div>

            <!-- Header with status -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="card-title text-base">Processing Status</h3>
                <template x-if="status === 'processing'">
                    <span class="badge badge-primary badge-sm">
                        <span class="loading loading-spinner loading-xs mr-1"></span>
                        Processing
                    </span>
                </template>
                <template x-if="status === 'completed'">
                    <span class="badge badge-success badge-sm">Complete</span>
                </template>
                <template x-if="status === 'error'">
                    <span class="badge badge-error badge-sm">Error</span>
                </template>
            </div>

            <!-- Progress Steps -->
            <ul class="steps steps-vertical lg:steps-horizontal w-full mb-4">
                <li class="step" x-bind:class="currentStep >= 0 ? 'step-primary' : ''">
                    <span class="text-xs">Queued</span>
                </li>
                <li class="step" x-bind:class="currentStep >= 1 ? 'step-primary' : ''">
                    <span class="text-xs">Downloading</span>
                </li>
                <li class="step" x-bind:class="currentStep >= 2 ? 'step-primary' : ''">
                    <span class="text-xs">Analyzing</span>
                </li>
                <li class="step" x-bind:class="currentStep >= 3 ? 'step-primary' : ''">
                    <span class="text-xs">Complete</span>
                </li>
            </ul>

            <!-- Current activity message -->
            <template x-if="status === 'processing'">
                <div class="flex items-center gap-2 text-sm text-base-content/70 mb-4">
                    <span class="loading loading-dots loading-sm"></span>
                    <span x-text="currentStep === 1 ? 'Downloading document...' : currentStep === 2 ? 'Analyzing with AI...' : 'Processing...'"></span>
                </div>
            </template>

            <!-- Streaming LLM Output (only if available) -->
            <template x-if="llmOutput.length > 0">
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <span class="text-sm font-medium">AI Analysis</span>
                    </div>
                    <div class="bg-base-200 rounded-lg p-3 max-h-64 overflow-y-auto font-mono text-xs whitespace-pre-wrap">
                        <span x-text="llmOutput"></span>
                        <span x-show="status === 'processing'" class="inline-block w-2 h-4 bg-primary animate-pulse ml-0.5"></span>
                    </div>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="status === 'error'">
                <div class="alert alert-error">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <h3 class="font-bold">Processing Failed</h3>
                        <div class="text-xs" x-text="errorMessage"></div>
                    </div>
                    <button class="btn btn-sm" @click="reprocessAndReset()">Retry</button>
                </div>
            </template>

            <!-- Duration (when complete) -->
            <template x-if="status === 'completed' && durationMs > 0">
                <div class="text-xs text-base-content/50 text-right">
                    Processed in <span x-text="(durationMs / 1000).toFixed(1)"></span>s
                </div>
            </template>
        </div>
    </div>

    <script>
    function processingStatus(documentId) {
        return {
            documentId: documentId,
            status: 'processing',
            currentStep: 0,
            llmOutput: '',
            errorMessage: '',
            durationMs: 0,
            subscription: null,
            initialized: false,

            async init() {
                // Guard against double initialization (Alpine can call init multiple times)
                if (this.initialized) {
                    console.log('Already initialized, skipping');
                    return;
                }
                this.initialized = true;

                console.log('Processing status component init for document:', this.documentId);

                // Wait for Supabase client AND auth to be ready
                const client = await window.waitForSupabase();
                if (!client) {
                    console.error('Supabase client not available');
                    return;
                }

                console.log('Supabase ready, loading history and subscribing...');
                await this.loadHistory();
                this.subscribe();
            },

            async loadHistory() {
                console.log('Loading event history for document:', this.documentId);
                try {
                    const { data, error } = await window.supabaseClient
                        .from('document_processing_events')
                        .select('*')
                        .eq('document_id', this.documentId)
                        .order('sequence_num', { ascending: true });

                    if (error) {
                        console.error('Failed to load event history:', error);
                        return;
                    }

                    // Only process events from the LATEST processing run
                    // Find the last 'started' event and only process from there
                    let lastStartedIdx = -1;
                    for (let i = (data || []).length - 1; i >= 0; i--) {
                        if (data[i].event_type === 'started') {
                            lastStartedIdx = i;
                            break;
                        }
                    }

                    const recentEvents = lastStartedIdx >= 0 ? data.slice(lastStartedIdx) : data || [];
                    console.log('Processing', recentEvents.length, 'events from latest run (of', data?.length, 'total)');

                    for (const event of recentEvents) {
                        console.log('Processing history event:', event.event_type, event.sequence_num);
                        this.handleEvent(event);
                    }
                    console.log('After processing history: status=', this.status, 'currentStep=', this.currentStep);
                } catch (err) {
                    console.error('Error loading history:', err);
                }
            },

            subscribe() {
                console.log('Subscribing to realtime events for document:', this.documentId);
                this.subscription = window.supabaseClient
                    .channel('doc-processing-' + this.documentId)
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'document_processing_events',
                            filter: 'document_id=eq.' + this.documentId
                        },
                        (payload) => {
                            console.log('Received realtime event:', payload.new?.event_type);
                            this.handleEvent(payload.new);
                        }
                    )
                    .subscribe((status) => {
                        console.log('Subscription status:', status);
                    });
            },

            handleEvent(event) {
                // Parse event_data if it's a string (can happen with some Supabase configs)
                let data = event.event_data || {};
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        console.error('Failed to parse event_data:', e);
                        data = {};
                    }
                }

                console.log('Handling event:', event.event_type, data);

                switch (event.event_type) {
                    case 'started':
                        console.log('-> Setting status=processing, currentStep=1');
                        this.status = 'processing';
                        this.currentStep = 1;
                        break;

                    case 'step':
                        console.log('-> Step event, step=', data.step);
                        if (data.step === 'extracting') {
                            this.currentStep = 2;
                        }
                        break;

                    case 'llm_chunk':
                        if (data.content) {
                            this.llmOutput += data.content;
                        }
                        break;

                    case 'completed':
                        console.log('-> Completed! duration=', data.duration_ms);
                        this.status = 'completed';
                        this.currentStep = 3;
                        this.durationMs = data.duration_ms || 0;
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                        break;

                    case 'error':
                        console.log('-> Error:', data.error);
                        this.status = 'error';
                        this.errorMessage = data.error || 'Unknown error';
                        break;

                    default:
                        console.log('-> Unknown event type:', event.event_type);
                }
            },

            reprocessAndReset() {
                this.status = 'processing';
                this.currentStep = 0;
                this.llmOutput = '';
                this.errorMessage = '';
                reprocessDocument();
            }
        };
    }
    </script>
    {{end}}

    <!-- Status Card -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <h2 class="card-title text-lg">Status</h2>
                {{if eq .Data.Document.ProcessingStatus "pending"}}
                <span class="badge badge-warning gap-1">
                    <span class="loading loading-spinner loading-xs"></span>
                    Processing
                </span>
                {{else if eq .Data.Document.ProcessingStatus "complete"}}
                <span class="badge badge-success">Processed</span>
                {{else if eq .Data.Document.ProcessingStatus "failed"}}
                <span class="badge badge-error">Failed</span>
                {{else}}
                <span class="badge">{{.Data.Document.ProcessingStatus}}</span>
                {{end}}
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                <div>
                    <div class="text-sm text-base-content/60">Size</div>
                    <div class="font-medium">{{formatBytes .Data.Document.SizeBytes}}</div>
                </div>
                <div>
                    <div class="text-sm text-base-content/60">Type</div>
                    <div class="font-medium">{{.Data.Document.ContentType}}</div>
                </div>
                <div>
                    <div class="text-sm text-base-content/60">Uploaded</div>
                    <div class="font-medium">{{.Data.Document.CreatedAt.Format "Jan 2, 2006 3:04 PM"}}</div>
                </div>
                {{if .Data.Document.ProcessedAt}}
                <div>
                    <div class="text-sm text-base-content/60">Processed</div>
                    <div class="font-medium">{{.Data.Document.ProcessedAt.Format "Jan 2, 2006 3:04 PM"}}</div>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Linked Items -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <h2 class="card-title text-lg mb-4">Linked To</h2>

            {{if or .Data.Property .Data.System}}
            <div class="space-y-3">
                {{if .Data.Property}}
                <a href="/properties/{{.Data.Property.ID}}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-200 transition-colors">
                    <div class="bg-primary/10 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </div>
                    <div>
                        <div class="font-medium">{{.Data.Property.Name}}</div>
                        <div class="text-sm text-base-content/60">Property</div>
                    </div>
                </a>
                {{end}}
                {{if .Data.System}}
                <a href="/systems/{{.Data.System.ID}}" class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-200 transition-colors">
                    <div class="bg-base-200 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div>
                        <div class="font-medium">{{.Data.System.Name}}</div>
                        <div class="text-sm text-base-content/60">System</div>
                    </div>
                </a>
                {{end}}
            </div>
            {{else}}
            <div class="text-center py-6">
                <p class="text-base-content/60 text-sm mb-3">Not linked to any property or system yet.</p>
                <button class="btn btn-primary btn-sm" onclick="link_modal.showModal()">Link Document</button>
            </div>
            {{end}}
            {{if or .Data.Property .Data.System}}
            <div class="mt-4 pt-4 border-t border-base-200">
                <button class="btn btn-ghost btn-sm" onclick="link_modal.showModal()">Change Link</button>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Document Preview -->
    {{if .Data.SignedURL}}
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <h2 class="card-title text-lg mb-4">Preview</h2>
            {{if eq .Data.Document.ContentType "application/pdf"}}
            <iframe src="{{.Data.SignedURL}}" class="w-full h-96 rounded-lg border"></iframe>
            {{else}}
            <img src="{{.Data.SignedURL}}" alt="{{.Data.Document.Filename}}" class="max-w-full rounded-lg" />
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Extracted Data -->
    {{if .Data.Document.ExtractedData}}
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <h2 class="card-title text-lg mb-4">Extracted Information</h2>
            <pre class="bg-base-200 p-4 rounded-lg text-sm overflow-x-auto">{{formatJSON .Data.Document.ExtractedData}}</pre>
        </div>
    </div>
    {{end}}
</div>

<!-- Link Document Modal -->
<dialog id="link_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box modal-content">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-xl">Link Document</h3>
            <button type="button" class="btn btn-sm btn-circle btn-ghost" onclick="link_modal.close()">✕</button>
        </div>
        <form id="link_form" class="space-y-4">
            <div class="form-control">
                <label class="label py-1">
                    <span class="label-text">Property</span>
                </label>
                <select name="property_id" class="select select-bordered w-full">
                    <option value="">None</option>
                    {{range .Data.Properties}}
                    <option value="{{.ID}}" {{if and $.Data.Property (eq $.Data.Property.ID .ID)}}selected{{end}}>{{.Name}}</option>
                    {{end}}
                </select>
            </div>
            <div class="form-control">
                <label class="label py-1">
                    <span class="label-text">System</span>
                </label>
                <select name="system_id" class="select select-bordered w-full">
                    <option value="">None</option>
                    {{range .Data.Systems}}
                    <option value="{{.ID}}" {{if and $.Data.System (eq $.Data.System.ID .ID)}}selected{{end}}>{{.Name}}</option>
                    {{end}}
                </select>
            </div>
            <div class="modal-action mt-6">
                <button type="button" class="btn btn-ghost" onclick="link_modal.close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button class="cursor-default">​</button>
    </form>
</dialog>

<script>
document.getElementById('link_form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/documents/{{.Data.Document.ID}}/link', {
        method: 'PUT',
        body: new URLSearchParams(formData)
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to link document');
        }
    })
    .catch(error => alert('Error: ' + error.message));
});

function deleteDocument() {
    if (confirm('Delete this document? This cannot be undone.')) {
        fetch('/documents/{{.Data.Document.ID}}', { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/documents';
                } else {
                    alert('Failed to delete document');
                }
            })
            .catch(error => alert('Error: ' + error.message));
    }
}

function reprocessDocument() {
    const btn = document.getElementById('reprocess-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Processing...';

    fetch('/documents/{{.Data.Document.ID}}/reprocess', { method: 'POST' })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to queue document for reprocessing');
                btn.disabled = false;
                btn.textContent = 'Reprocess';
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            btn.disabled = false;
            btn.textContent = 'Reprocess';
        });
}
</script>
{{end}}
